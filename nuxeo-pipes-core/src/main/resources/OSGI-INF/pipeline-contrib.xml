<?xml version="1.0"?>
<component name="org.nuxeo.runtime.stream.pipes.Pipeline" version="1.0">

  <require>org.nuxeo.ecm.core.event.EventServiceComponent</require>
  <require>org.nuxeo.runtime.stream.service</require>
  <implementation class="org.nuxeo.runtime.stream.pipes.services.PipelineServiceImpl"/>

  <service>
    <provide interface="org.nuxeo.runtime.stream.pipes.services.PipelineService"/>
  </service>

  <extension-point name="pipes">
    <documentation>
      Configure a pipeline to send an event to a nuxeo-stream.
      <code>
        <pipe id="pipe.myid" enabled="true" function="org.nuxeo.my.DocumentPipeFunction">
          <supplier>
            <event>myDocEvent</event>
          </supplier>
          <consumer>
            <stream name="text"/>
          </consumer>
        </pipe>
      </code>
    </documentation>
    <object class="org.nuxeo.runtime.stream.pipes.services.PipeDescriptor"/>
  </extension-point>

  <extension point="pipes" target="org.nuxeo.runtime.stream.pipes.Pipeline">
    <pipe id="pipe.images" enabled="true">
      <supplier>
        <event name="pictureViewsGenerationDone">
          <filter class="org.nuxeo.runtime.stream.pipes.filters.NotSystemOrProxyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.FacetFilter">
            <option name="includedFacets">Picture</option>
          </filter>
        </event>
        <event name="documentCreated">
          <filter class="org.nuxeo.runtime.stream.pipes.filters.NotSystemOrProxyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.FacetFilter">
            <option name="excludedFacets">Picture,Folderish</option>
          </filter>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.MimeBlobPropertyFilter">
            <option name="mimePattern">image.*</option>
            <option name="properties">file:content</option>
          </filter>
        </event>
        <event name="documentModified">
          <filter class="org.nuxeo.runtime.stream.pipes.filters.NotSystemOrProxyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.DirtyPropertyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.FacetFilter">
            <option name="excludedFacets">Picture,Folderish</option>
          </filter>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.MimeBlobPropertyFilter">
            <option name="mimePattern">image.*</option>
          </filter>
          <option name="properties">file:content</option>
        </event>
      </supplier>
      <consumer>
        <stream name="images"/>
      </consumer>
      <transformer class="org.nuxeo.runtime.stream.pipes.functions.PropertiesToStream">
        <option name="blobProperties">file:content</option>
      </transformer>
    </pipe>

    <pipe id="pipe.video" enabled="true" function="org.nuxeo.runtime.stream.pipes.functions.PropertiesToStream">
      <supplier>

        "Video",

        <event name="documentCreated">
          <filter class="org.nuxeo.runtime.stream.pipes.filters.NotSystemOrProxyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.MimeBlobPropertyFilter">
            <option name="mimePattern">video.*</option>
            <option name="properties">file:content</option>
          </filter>
        </event>
        <event name="documentModified">
          <filter class="org.nuxeo.runtime.stream.pipes.filters.NotSystemOrProxyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.DirtyPropertyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.MimeBlobPropertyFilter">
            <option name="mimePattern">video.*</option>
          </filter>
          <option name="properties">file:content</option>
        </event>
      </supplier>
      <consumer>
        <stream name="video"/>
      </consumer>
      <transformer>
        <option name="blobProperties">file:content</option>
      </transformer>
    </pipe>

    <pipe id="pipe.audio" enabled="true">
      <supplier>

        ,"Audio"

        <event name="documentCreated">
          <filter class="org.nuxeo.runtime.stream.pipes.filters.NotSystemOrProxyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.MimeBlobPropertyFilter">
            <option name="mimePattern">audio.*</option>
            <option name="properties">file:content</option>
          </filter>
        </event>
        <event name="documentModified">
          <filter class="org.nuxeo.runtime.stream.pipes.filters.NotSystemOrProxyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.DirtyPropertyFilter"/>
          <filter class="org.nuxeo.runtime.stream.pipes.filters.MimeBlobPropertyFilter">
            <option name="mimePattern">audio.*</option>
          </filter>
          <option name="properties">file:content</option>
        </event>
      </supplier>
      <consumer>
        <stream name="audio"/>
      </consumer>
      <transformer>
        <option name="blobProperties">file:content</option>
      </transformer>
    </pipe>
  </extension>
</component>
